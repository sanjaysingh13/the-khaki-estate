{% extends "base.html" %} {% load static %} {% block title %}{{ maintenance_request.ticket_number }} - Maintenance Request Details{% endblock %} {% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Request Details Card -->
        <div class="card">
            <!-- Card Header -->
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-{% if maintenance_request.status == 'resolved' %}success{% elif maintenance_request.status == 'in_progress' %}warning{% elif maintenance_request.status == 'submitted' %}info{% else %}secondary{% endif %} me-2">
                    {{ maintenance_request.get_status_display }}
                  </span>
                            <span class="badge bg-{% if maintenance_request.priority == 4 %}danger{% elif maintenance_request.priority == 3 %}warning{% elif maintenance_request.priority == 2 %}info{% else %}secondary{% endif %} me-2">
                    {{ maintenance_request.get_priority_display }}
                  </span>
                            <span class="badge bg-primary">{{ maintenance_request.category.name }}</span>
                        </div>
                        <h1 class="h4 mb-0">{{ maintenance_request.ticket_number }}</h1>
                        <h5 class="text-muted mb-0">{{ maintenance_request.title }}</h5>
                    </div>
                    <div class="text-end">
                        {% if can_manage %}
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="fas fa-cog me-1"></i>Manage
                    </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#statusModal">
                                        <i class="fas fa-edit me-2"></i>Update Status
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#assignmentModal">
                                        <i class="fas fa-user-plus me-2"></i>Assign Staff
                                    </a>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Card Body -->
            <div class="card-body">
                <!-- Description -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Description</h6>
                    <p>{{ maintenance_request.description|linebreaks }}</p>
                </div>
                <!-- Request Details Grid -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="border rounded p-3">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-map-marker-alt me-1"></i>Location
                            </h6>
                            <p class="mb-0">{{ maintenance_request.location }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-user me-1"></i>Reported By
                            </h6>
                            <p class="mb-0">{{ maintenance_request.resident.get_full_name }}</p>
                            <small class="text-muted">{{ maintenance_request.resident.flat_number }}</small>
                        </div>
                    </div>
                </div>
                <!-- Assigned Staff (Committee View) -->
                {% if can_manage and maintenance_request.assigned_to %}
                <div class="mb-4">
                    <div class="border rounded p-3">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-user-check me-1"></i>Assigned To
                        </h6>
                        <p class="mb-0">{{ maintenance_request.assigned_to.get_full_name }}</p>
                        <small class="text-muted">{{ maintenance_request.assigned_to.phone_number }}</small>
                    </div>
                </div>
                {% endif %}
                <!-- Attachment -->
                {% if maintenance_request.attachment %}
                <div class="mb-4">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-paperclip me-1"></i>Attachment
                    </h6>
                    <div class="border rounded p-3">
                        <div class="d-flex align-items-center">
                            <img src="{{ maintenance_request.attachment.url }}" alt="Request attachment" class="img-thumbnail me-3" style="max-width: 100px;
                                max-height: 100px" />
                            <div class="flex-grow-1">
                                <div class="fw-bold">{{ maintenance_request.attachment.name|slice:"12:" }}</div>
                                <small class="text-muted">{{ maintenance_request.attachment.size|filesizeformat }}</small>
                            </div>
                            <a href="{{ maintenance_request.attachment.url }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                <i class="fas fa-download me-1"></i>View Full Size
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                <!-- Timestamps -->
                <div class="border-top pt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    <strong>Created:</strong> {{ maintenance_request.created_at|date:"F d, Y \a\t g:i A" }}
                  </small>
                        </div>
                        {% if maintenance_request.resolved_at %}
                        <div class="col-md-6">
                            <small class="text-muted">
                      <i class="fas fa-check-circle me-1"></i>
                      <strong>Resolved:</strong> {{ maintenance_request.resolved_at|date:"F d, Y \a\t g:i A" }}
                    </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Updates Timeline -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history text-primary me-2"></i> Updates & Comments
                </h5>
            </div>
            <div class="card-body">
                <!-- Add Update Form -->
                <form id="update-form" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="update-content" class="form-label">Add Update</label>
                        <textarea class="form-control" id="update-content" name="content" rows="3" placeholder="Add an update or comment about this request..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="update-attachment" class="form-label">Attachment (Optional)</label>
                        <input type="file" class="form-control" id="update-attachment" name="attachment" accept="image/*" />
                    </div>
                    <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>Add Update
              </button>
                </form>
                <!-- Updates Timeline -->
                <div id="updates-container">
                    {% if updates %}
                    <div class="timeline">
                        {% for update in updates %}
                        <div class="timeline-item" data-update-id="{{ update.id }}">
                            <div class="timeline-marker">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">{{ update.author.get_full_name }}</h6>
                                    <small class="text-muted">{{ update.created_at|timesince }} ago</small>
                                </div>
                                {% if update.status_changed_to %}
                                <div class="alert alert-info py-2 mb-2">
                                    <i class="fas fa-info-circle me-1"></i> Status changed to: <strong>{{ update.get_status_changed_to_display }}</strong>
                                </div>
                                {% endif %}
                                <p class="mb-2">{{ update.content|linebreaks }}</p>
                                {% if update.attachment %}
                                <div class="mb-2">
                                    <img src="{{ update.attachment.url }}" alt="Update attachment" class="img-thumbnail" style="max-width: 150px;
                                        max-height: 150px" />
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-comments text-muted fa-3x mb-3"></i>
                        <p class="text-muted">No updates yet. Add the first update!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog text-secondary me-2"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'backend:maintenance_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Requests
                    </a>
                    <a href="{% url 'backend:maintenance_create' %}" class="btn btn-outline-success">
                        <i class="fas fa-plus me-2"></i>New Request
                    </a>
                    {% if can_manage %}
                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#statusModal">
                  <i class="fas fa-edit me-2"></i>Update Status
                </button>
                    <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#assignmentModal">
                  <i class="fas fa-user-plus me-2"></i>Assign Staff
                </button> {% endif %}
                </div>
            </div>
        </div>
        <!-- Request Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-info me-2"></i> Request Info
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3">
                            <div class="h5 mb-0 text-primary">{{ updates|length }}</div>
                            <small class="text-muted">Updates</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3">
                            <div class="h5 mb-0 text-success">
                                {% if maintenance_request.resolved_at %} {{ maintenance_request.resolved_at|timesince:maintenance_request.created_at }} {% else %} Ongoing {% endif %}
                            </div>
                            <small class="text-muted">Duration</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Contact Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-phone text-success me-2"></i> Contact Info
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item border-0 px-0">
                        <h6 class="mb-1">{{ maintenance_request.resident.get_full_name }}</h6>
                        <small class="text-muted">Flat {{ maintenance_request.resident.flat_number }}</small>
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <i class="fas fa-phone text-muted me-2"></i>
                        <a href="tel:{{ maintenance_request.resident.phone_number }}" class="text-decoration-none">{{ maintenance_request.resident.phone_number }}</a>
                    </div>
                    {% if maintenance_request.resident.alternate_phone %}
                    <div class="list-group-item border-0 px-0">
                        <i class="fas fa-phone text-muted me-2"></i>
                        <a href="tel:{{ maintenance_request.resident.alternate_phone }}" class="text-decoration-none">{{ maintenance_request.resident.alternate_phone }}</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="status-form">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-status" class="form-label">New Status</label>
                        <select class="form-select" id="new-status" name="status" required>
                <option value="">Select status...</option>
                <option value="acknowledged">Acknowledged</option>
                <option value="in_progress">In Progress</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
              </select>
                    </div>
                    <div class="mb-3">
                        <label for="status-comment" class="form-label">Comment (Optional)</label>
                        <textarea class="form-control" id="status-comment" name="comment" rows="3" placeholder="Add a comment about this status change..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Assignment Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignment-form">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="assigned-staff" class="form-label">Assign To</label>
                        <select class="form-select" id="assigned-staff" name="assigned_to">
                <option value="">Select staff member...</option>
                {% for staff in available_staff %}
                  <option value="{{ staff.id }}"
                          {% if maintenance_request.assigned_to == staff %}selected{% endif %}>{{ staff.get_full_name }}</option>
                {% endfor %}
              </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- CSS for Timeline -->
<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -35px;
        top: 5px;
        width: 12px;
        height: 12px;
        background-color: #007bff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .timeline-marker i {
        font-size: 6px;
        color: white;
    }
    
    .timeline-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid #007bff;
    }
</style>
<!-- JavaScript for Interactive Features -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update form submission
        const updateForm = document.getElementById('update-form');
        if (updateForm) {
            updateForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const content = formData.get('content').trim();

                if (!content) {
                    alert('Please enter an update.');
                    return;
                }

                fetch('{% url "backend:add_maintenance_update" maintenance_request.id %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addUpdateToDOM(data.update);
                            this.reset();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while adding the update.');
                    });
            });
        }

        // Status form submission
        const statusForm = document.getElementById('status-form');
        if (statusForm) {
            statusForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);

                fetch('{% url "backend:update_maintenance_status" maintenance_request.id %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while updating the status.');
                    });
            });
        }

        // Assignment form submission
        const assignmentForm = document.getElementById('assignment-form');
        if (assignmentForm) {
            assignmentForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);

                fetch('{% url "backend:update_maintenance_status" maintenance_request.id %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while assigning staff.');
                    });
            });
        }

        // Function to add new update to DOM
        function addUpdateToDOM(update) {
            const updatesContainer = document.getElementById('updates-container');
            const updateHTML = `
            <div class="timeline-item" data-update-id="${update.id}">
                <div class="timeline-marker">
                    <i class="fas fa-circle"></i>
                </div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">${update.author}</h6>
                        <small class="text-muted">Just now</small>
                    </div>
                    <p class="mb-2">${update.content.replace(/\n/g, '<br />')}</p>
                    ${update.has_attachment ? '<div class="mb-2"><i class="fas fa-paperclip text-muted"></i> <small class="text-muted">Attachment included</small></div>' : ''}
                </div>
            </div>
        `;

            // If no updates exist, replace the empty state
            if (updatesContainer.querySelector('.text-center')) {
                updatesContainer.innerHTML = updateHTML;
            } else {
                updatesContainer.insertAdjacentHTML('beforeend', updateHTML);
            }
        }
    });
</script>
{% endblock %}